#!/usr/bin/env bash
# create_droplet_nyc.sh
# نیازمندی‌ها: curl, jq, sshpass
set -euo pipefail

read -sp "Enter your DigitalOcean API token: " DO_TOKEN
echo ""

API="https://api.digitalocean.com/v2/droplets"
DROPLET_PASSWORD="M#f4Z!7\$p9m"

# بررسی و نصب sshpass
if ! command -v sshpass &> /dev/null; then
    echo "sshpass not found. Installing..."
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        if command -v apt &> /dev/null; then
            sudo apt update && sudo apt install -y sshpass
        elif command -v yum &> /dev/null; then
            sudo yum install -y sshpass
        else
            echo "Please install sshpass manually for your distro."
            exit 1
        fi
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        if command -v brew &> /dev/null; then
            brew install hudochenkov/sshpass/sshpass
        else
            echo "Please install sshpass manually on macOS."
            exit 1
        fi
    fi
fi

# user_data برای تنظیم پسورد root
USER_DATA="#!/bin/bash
echo 'root:$DROPLET_PASSWORD' | chpasswd
sed -i 's/^#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
systemctl restart sshd"

# Payload JSON با user_data
payload=$(jq -n \
  --arg name "vm1" \
  --arg region "nyc3" \
  --arg size "s-1vcpu-1gb" \
  --arg image "ubuntu-24-04-x64" \
  --arg tag "first-project" \
  --arg user_data "$USER_DATA" \
  '{
    name: $name,
    region: $region,
    size: $size,
    image: $image,
    backups: false,
    ipv6: true,
    tags: [$tag],
    monitoring: true,
    "ssh_keys": [],
    "user_data": $user_data
  }'
)

# ایجاد Droplet
echo "Creating droplet 'vm1'..."
response=$(curl -sS -X POST "$API" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $DO_TOKEN" \
  -d "$payload")

DROPLET_ID=$(echo "$response" | jq -r '.droplet.id // empty')
if [[ -z "$DROPLET_ID" ]]; then
  echo "Failed to create droplet. Response:"
  echo "$response" | jq .
  exit 1
fi
echo "Droplet created with ID: $DROPLET_ID"

# Poll تا فعال شدن Droplet
echo "Waiting for droplet to become active..."
while true; do
  sleep 5
  status=$(curl -sS -H "Authorization: Bearer $DO_TOKEN" "$API/$DROPLET_ID" | jq -r '.droplet.status')
  echo "Status: $status"
  if [[ "$status" == "active" ]]; then
    IPDROPLET=$(curl -sS -H "Authorization: Bearer $DO_TOKEN" "$API/$DROPLET_ID" \
      | jq -r '.droplet.networks.v4[] | select(.type=="public") | .ip_address')
    echo "Droplet is active! Public IPv4: $IPDROPLET"
    break
  fi
done

# صبر کوتاه تا SSH آماده شود
echo "Waiting 30 seconds for SSH service to start..."
sleep 30

# اتصال خودکار با sshpass
echo "Connecting to Droplet via SSH..."
sshpass -p "$DROPLET_PASSWORD" ssh -o StrictHostKeyChecking=no root@"$IPDROPLET"
