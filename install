#!/usr/bin/env bash
# create_droplet_nyc.sh
# نیازمندی‌ها: curl, jq
# استفاده: ./create_droplet_nyc.sh
set -euo pipefail

# دریافت توکن از کاربر
read -sp "Enter your DigitalOcean API token: " DO_TOKEN
echo ""

API="https://api.digitalocean.com/v2/droplets"

# کلید عمومی SSH شما
SSH_KEY="ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDuyuGdmnjgliXdKxAG4Y8oC22LNS4nUwKYJ20woZp4Di9Ia5SPInlvZSCF2cywVkgAmmI73nM4hS7NJTvCJBzP5Qhn9xi/UhF9wHlZSWzhlYkg1KiAXUXOd9B0UtU9q/d3WMnNYn63wBOy1PmRJqFu/DpeYFZmvg7JBzCHHd46B6Za0WXmDPfP0if9PPNeFH9xZigaDFvyQexRSL5hNSQgaHHM5yCHP3to66tPFV+YFjLzwLNVgj1n55gbr/wn8eNgS1p4Z3pAxHaXyz/UtFJyadZ2BXodmpMb8ZZjt1TZwaKyvC3E3nmetd6QqJS3lUt7NTvFvJhBpOD4fHVDyj9EyoKY/os2x6ZPZOk0ucO4Q8pRuIsV8Qw/DLV5JXn1BQMeMtC7Dj5cxQ0IQdObMUTjgY7HBCFCCw+d8SwUU7kxAq0irHEqhRkD1KV9x33/+gG/1/BUMjQ8MxI82Wk1wk3os5+/TJwb+hCzwiunxQYkFMR8DcnU9o90sDvEy0Rm/JU="

# Payload JSON
payload=$(jq -n \
  --arg name "vm1" \
  --arg region "nyc3" \
  --arg size "s-1vcpu-1gb" \
  --arg image "ubuntu-24-04-x64" \
  --arg tag "first-project" \
  --arg ssh_key "$SSH_KEY" \
  '{
    name: $name,
    region: $region,
    size: $size,
    image: $image,
    backups: false,
    ipv6: true,
    tags: [$tag],
    monitoring: true,
    "ssh_keys": [$ssh_key],
    "user_data": "",
    "features": []
  }'
)

# ایجاد droplet
echo "Creating droplet 'vm1' in New York..."
response=$(curl -sS -X POST "$API" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $DO_TOKEN" \
  -d "$payload")

# گرفتن ID
DROPLET_ID=$(echo "$response" | jq -r '.droplet.id // empty')
if [[ -z "$DROPLET_ID" ]]; then
  echo "Failed to create droplet. Response:"
  echo "$response" | jq .
  exit 1
fi
echo "Droplet created with ID: $DROPLET_ID"

# Poll until droplet becomes active
echo "Waiting for droplet to become active..."
while true; do
  sleep 5
  status=$(curl -sS -H "Authorization: Bearer $DO_TOKEN" "$API/$DROPLET_ID" | jq -r '.droplet.status')
  echo "Status: $status"
  if [[ "$status" == "active" ]]; then
    ipv4=$(curl -sS -H "Authorization: Bearer $DO_TOKEN" "$API/$DROPLET_ID" | jq -r '.droplet.networks.v4[] | select(.type=="public") | .ip_address')
    echo "Droplet is active! Public IPv4: $ipv4"
    echo "Connect using: ssh root@$ipv4 -i ~/.ssh/id_ed25519"
    break
  fi
done
