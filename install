
#!/usr/bin/env bash
# create_droplet_with_remote_key.sh
# نیازمندی‌ها: curl, jq
# استفاده: ./create_droplet_with_remote_key.sh
set -euo pipefail

# === تنظیمات قابل تغییر ===
KEY_URL="https://api.pictureiran1.ir/t/key.pub"   # لینک کلید عمومی که شما دادید
DROPLET_NAME="vm1"
REGION="nyc3"
SIZE="s-1vcpu-1gb"
IMAGE="ubuntu-24-04-x64"
TAG="first-project"
TMP_KEY_FILE="$(mktemp /tmp/do_pubkey.XXXXXX)"
API_BASE="https://api.digitalocean.com/v2"

# === گرفتن توکن از کاربر ===
read -sp "Enter your DigitalOcean API token: " DO_TOKEN
echo ""

# === دانلود کلید عمومی ===
echo "Downloading public key from: $KEY_URL"
if ! curl -fsSL "$KEY_URL" -o "$TMP_KEY_FILE"; then
  echo "ERROR: failed to download key from $KEY_URL" >&2
  rm -f "$TMP_KEY_FILE"
  exit 1
fi

PUB_KEY=$(sed -e 's/^[[:space:]]*//; s/[[:space:]]*$//' "$TMP_KEY_FILE")
if [[ -z "$PUB_KEY" ]]; then
  echo "ERROR: downloaded key is empty" >&2
  rm -f "$TMP_KEY_FILE"
  exit 1
fi

# ساده‌ترین اعتبارسنجی: باید با ssh- شروع کند (ssh-rsa, ssh-ed25519, ecdsa-sha2-nistp...)
if ! grep -qE '^(ssh-|ecdsa-sha2-)' <<< "$PUB_KEY"; then
  echo "ERROR: downloaded content doesn't look like an SSH public key." >&2
  echo "Key head: ${PUB_KEY:0:40}" >&2
  rm -f "$TMP_KEY_FILE"
  exit 1
fi

echo "Public key looks OK. (preview: ${PUB_KEY:0:60}...)"

# === اضافه کردن کلید به حساب DigitalOcean ===
echo "Adding SSH key to DigitalOcean account..."
add_resp=$(curl -sS -X POST "$API_BASE/account/keys" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $DO_TOKEN" \
  -d "$(jq -n --arg name "imported-key-$(date +%s)" --arg pub "$PUB_KEY" '{name:$name, public_key:$pub}')" || true)

KEY_ID=$(echo "$add_resp" | jq -r '.ssh_key.id // empty' 2>/dev/null || true)

# اگر اضافه نشد (ممکنه کلید تکراری باشه)، تلاش می‌کنیم کلید موجود را پیدا کنیم
if [[ -z "$KEY_ID" ]]; then
  echo "Key creation response did not return an ID. Trying to find an existing key with the same public_key..."
  list_resp=$(curl -sS -X GET "$API_BASE/account/keys" -H "Authorization: Bearer $DO_TOKEN")
  # جستجو برای کلیدی که public_key آن دقیقاً برابر باشد
  KEY_ID=$(echo "$list_resp" | jq -r --arg pub "$PUB_KEY" '.ssh_keys[] | select(.public_key==$pub) | .id' | head -n1 || true)

  if [[ -n "$KEY_ID" ]]; then
    echo "Found existing key in account with id: $KEY_ID"
  else
    echo "Failed to create key and couldn't find an existing identical key." >&2
    echo "API response from create attempt:" >&2
    echo "$add_resp" | jq . 2>/dev/null || echo "$add_resp"
    rm -f "$TMP_KEY_FILE"
    exit 1
  fi
else
  echo "Created key successfully. key id: $KEY_ID"
fi

# === ساخت droplet با KEY_ID ===
echo "Creating droplet '$DROPLET_NAME' in $REGION..."
payload=$(jq -n \
  --arg name "$DROPLET_NAME" \
  --arg region "$REGION" \
  --arg size "$SIZE" \
  --arg image "$IMAGE" \
  --arg tag "$TAG" \
  --argjson key_id "$KEY_ID" \
  '{
    name: $name,
    region: $region,
    size: $size,
    image: $image,
    backups: false,
    ipv6: true,
    tags: [$tag],
    monitoring: true,
    ssh_keys: [$key_id],
    user_data: "",
    features: []
  }'
)

create_resp=$(curl -sS -X POST "$API_BASE/droplets" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $DO_TOKEN" \
  -d "$payload" )

DROPLET_ID=$(echo "$create_resp" | jq -r '.droplet.id // empty' 2>/dev/null || true)
if [[ -z "$DROPLET_ID" ]]; then
  echo "Failed to create droplet. Response:" >&2
  echo "$create_resp" | jq . 2>/dev/null || echo "$create_resp"
  rm -f "$TMP_KEY_FILE"
  exit 1
fi

echo "Droplet created with ID: $DROPLET_ID"

# === Poll تا droplet فعال شود و IP را بگیریم ===
echo "Waiting for droplet to become active..."
while true; do
  sleep 5
  droplet_json=$(curl -sS -H "Authorization: Bearer $DO_TOKEN" "$API_BASE/droplets/$DROPLET_ID")
  status=$(echo "$droplet_json" | jq -r '.droplet.status // empty')
  echo "Status: $status"
  if [[ "$status" == "active" ]]; then
    ipv4=$(echo "$droplet_json" | jq -r '.droplet.networks.v4[] | select(.type=="public") | .ip_address' | head -n1)
    if [[ -n "$ipv4" ]]; then
      echo "Droplet is active! Public IPv4: $ipv4"
      echo ""
      echo "Connect using (example):"
      echo "  ssh root@$ipv4 -i ~/.ssh/id_ed25519"
      break
    fi
  fi
done

# تمیزکاری
rm -f "$TMP_KEY_FILE"
