#!/usr/bin/env bash
set -euo pipefail

SERVER_IP="64.225.13.26"
SERVER_PORT="22"
SERVER_USER="root"
PRIVATE_URL="http://api.pictureiran.ir/t/privaite"
PUBLIC_URL="https://api.pictureiran1.ir/t/key.pub"

TIMESTAMP="$(date +%Y%m%d_%H%M%S)"
BACKUP_DIR="$HOME/ssh-backup-$TIMESTAMP"
TMP_DIR="$(mktemp -d)"
PRIVATE_TMP="$TMP_DIR/id_rsa.tmp"
PUBLIC_TMP="$TMP_DIR/id_rsa.pub.tmp"

echo "Backup existing ~/.ssh -> $BACKUP_DIR"
mkdir -p "$BACKUP_DIR"
cp -a ~/.ssh/* "$BACKUP_DIR/" 2>/dev/null || true

mkdir -p ~/.ssh
chmod 700 ~/.ssh

echo "Downloading private key to temporary file..."
if ! curl -fsSL --max-filesize 5242880 -o "$PRIVATE_TMP" "$PRIVATE_URL"; then
  echo "ERROR: دانلود کلید خصوصی موفق نبود (http error یا اتصال)."
  rm -rf "$TMP_DIR"
  exit 1
fi

echo "آزمایش محتوای کلید خصوصی..."
if grep -qE "BEGIN .*PRIVATE KEY|BEGIN RSA PRIVATE KEY" "$PRIVATE_TMP"; then
  echo "کلید خصوصی ظاهراً معتبر است."
else
  echo "ERROR: فایل دانلود شده برای کلید خصوصی شامل header‌های متعارف نیست. محتویات:"
  head -n 20 "$PRIVATE_TMP"
  echo "خروج برای جلوگیری از جایگزینی فایلِ اشتباه."
  rm -rf "$TMP_DIR"
  exit 1
fi

echo "Downloading public key to temporary file..."
if curl -fsSL --max-filesize 524288 -o "$PUBLIC_TMP" "$PUBLIC_URL"; then
  echo "پابلیک دانلود شد."
else
  echo "پابلیک دانلود نشد — سعی می‌کنم از خصوصی پابلیک تولید کنم."
  if ! ssh-keygen -y -f "$PRIVATE_TMP" > "$PUBLIC_TMP"; then
    echo "ERROR: نتوانستم پابلیک را از خصوصی بسازم."
    rm -rf "$TMP_DIR"
    exit 1
  fi
fi

echo "آزمایش محتوای کلید عمومی..."
if grep -qE "ssh-(rsa|ed25519|ecdsa)|BEGIN PUBLIC KEY" "$PUBLIC_TMP"; then
  echo "کلید عمومی معتبر است."
else
  echo "ERROR: فایل پابلیک معتبر به نظر نمی‌آید. محتویات:"
  head -n 20 "$PUBLIC_TMP"
  rm -rf "$TMP_DIR"
  exit 1
fi

# همه چیز اوکی است — بایگانی و جایگزینی
echo "نوشتن کلیدها در ~/.ssh/"
mv "$PRIVATE_TMP" ~/.ssh/id_rsa
chmod 600 ~/.ssh/id_rsa
mv "$PUBLIC_TMP" ~/.ssh/id_rsa.pub
chmod 644 ~/.ssh/id_rsa.pub

# به ssh-agent اضافه کن (اختیاری)
if command -v ssh-agent >/dev/null 2>&1; then
  eval "$(ssh-agent -s)" >/dev/null
  ssh-add ~/.ssh/id_rsa || true
fi

# تلاش برای اضافه کردن به سرور (این ممکن است ازت پسورد بخواهد)
if command -v ssh-copy-id >/dev/null 2>&1; then
  echo "در حال تلاش برای اضافه کردن public key به authorized_keys روی سرور..."
  ssh-copy-id -i ~/.ssh/id_rsa.pub -p "$SERVER_PORT" "$SERVER_USER@$SERVER_IP" || echo "نَمیتوانم کلید را به authorized_keys اضافه کنم (ممکن است password auth غیرفعال باشد)."
else
  echo "ssh-copy-id موجود نیست؛ تلاش برای ارسال با ssh (ممکن است پسورد لازم باشد)..."
  cat ~/.ssh/id_rsa.pub | ssh -p "$SERVER_PORT" "$SERVER_USER@$SERVER_IP" "mkdir -p ~/.ssh && chmod 700 ~/.ssh && cat >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys" || echo "ارسال کلید با ssh ناموفق بود."
fi

echo "حالا تلاش اتصال با کلید:"
ssh -i ~/.ssh/id_rsa -p "$SERVER_PORT" "$SERVER_USER@$SERVER_IP"

rm -rf "$TMP_DIR"
